# GRBL_ESP32 Liquid Handling Robot - Project Summary & Failure Analysis

**Date:** November 14, 2025  
**Repository:** https://github.com/keithcausey/LiquidHandlingRobot01  
**Status:** ❌ **PROJECT FAILURE** - GRBL_ESP32 incompatible with ESP32-S3

## Executive Summary

This project attempted to build a 4-axis liquid handling robot using GRBL_ESP32 firmware on an ESP32-S3 microcontroller. While the hardware design and testing was successful, GRBL_ESP32 proved fundamentally incompatible with the ESP32-S3 platform due to serial communication and threading issues.

**Key Finding:** Hardware is 100% functional. The problem is entirely with GRBL_ESP32 firmware.

## Hardware Configuration (VERIFIED WORKING)

### ESP32-S3-DevKitC-1 Board
- **USB Ports:** 
  - USB-C: Native ESP32-S3 USB (COM12/COM13)
  - Micro-USB: CH340 UART bridge (GPIO43 TX, GPIO44 RX)
- **Power:** 5V via USB, 3.3V regulated
- **WiFi:** NETGEAR13 network, IP 10.0.0.12

### I2S Shift Register Control
- **74HC595 Cascade:** 3x 8-bit registers (24 total bits)
- **I2S Pins:**
  - GPIO 4: Serial data (SER)
  - GPIO 5: Shift register clock (SRCLK)  
  - GPIO 6: Register clock/latch (RCLK)
- **Logic:** Inverted via 6N136 optoisolators

### Motor Configuration (MKS Servo42C)
- **4 Axes:** X, Y, Z (positioning), A (syringe pump)
- **Microstepping:** 1 (full steps) - MKS Servo42C optimized
- **Steps/Revolution:** 200
- **Steps/mm:** 200 for all axes
- **Motor Enable:** GPIO 19 (STEPPER_RESET) - HIGH = enabled

### I2S Bit Mapping (Inverted Logic)
```
Register 0: X_STEP(0), X_DIR(1), Y_STEP(2), Y_DIR(3), Z_STEP(4), Z_DIR(5), A_STEP(6), A_DIR(7)
Register 1: X_EN(8), Y_EN(9), Z_EN(10), A_EN(11), USER_PIN_2(12), USER_PIN_3(13), USER_PIN_4(14), SPARE(15)
Register 2: EXPANSION(16-23)
```

### Limit Switches (Active HIGH)
- **X-Axis:** GPIO 8
- **Y-Axis:** GPIO 15  
- **Z-Axis:** GPIO 16
- **A-Axis:** GPIO 17 (VERIFIED: 41.5mm travel, 0.5mm pull-off)

### Safety System
- **Emergency Stop:** GPIO 19 (STEPPER_RESET) to AND gate
- **Feedback:** GPIO 21 (safety monitoring)
- **Logic:** GPIO 19 HIGH = motors enabled, GPIO 21 HIGH = safe

### Travel Limits (Measured/Estimated)
- **A-Axis:** 0 to 41.5mm (VERIFIED)
- **X/Y/Z Axes:** 0 to 200mm (to be measured)
- **Homing:** Z first, then X/Y together, A last

## Software Issues Encountered

### 1. USB CDC Serial Communication Failure
- **Problem:** ESP32-S3 native USB (COM12) not accepting input
- **Symptom:** Characters sent immediately, no buffering
- **Root Cause:** GRBL_ESP32 serial implementation incompatible with ESP32-S3 USB stack
- **Workaround:** Used CH340 UART bridge (GPIO43/44) - still failed

### 2. Serial Threading Crashes
- **Problem:** Spinlock assertion failures in Serial.cpp
- **Error:** `assert failed: spinlock_release spinlock.h:158`
- **Location:** clientCheckTask() at Serial.cpp:186
- **Attempts:** 
  - Changed UART pins from GPIO1/3 to GPIO43/44
  - Enabled REVERT_TO_ARDUINO_SERIAL
  - Still crashed consistently

### 3. Web Interface Command Failure
- **Problem:** Web UI at 10.0.0.12 accepts connections but commands fail
- **Symptom:** "connection error" on jog attempts
- **Telnet:** Port 23 connects briefly then drops

### 4. PlatformIO Monitor Issues
- **Problem:** `send_on_enter` filter not providing local echo
- **Workaround:** `--echo` flag required for visibility

## Successful Components

### ✅ A-Axis Motor Test (100% Working)
- **Program:** `verification_test/src/main.cpp`
- **Features:** Direct motor control, limit switch detection, safety monitoring
- **Results:** Perfect motor movement, accurate positioning, safety system functional
- **Proof:** Hardware configuration is correct

### ✅ Hardware Wiring & Logic
- **I2S Signals:** Verified working with walking patterns
- **Motor Control:** All 4 motors respond correctly
- **Limit Switches:** Active HIGH polarity confirmed
- **Safety System:** AND gate logic verified

### ✅ WiFi & Networking
- **Connection:** Stable WiFi connection to 10.0.0.12
- **Services:** HTTP, Telnet, mDNS working
- **Web Interface:** Accessible but commands fail

## GRBL_ESP32 vs ESP32-S3 Compatibility

**Conclusion:** GRBL_ESP32 v1.3a is not compatible with ESP32-S3 due to:
1. Serial communication stack differences
2. Threading model incompatibilities  
3. USB CDC implementation issues

**Recommendation:** Abandon GRBL_ESP32 for this project. Use FluidNC instead.

## FluidNC Configuration Reference

Based on verified working hardware, use these settings for FluidNC:

### Board Configuration
```
board: ESP32-S3-DevKitC-1
name: Liquid Handling Robot
```

### I2S Stepper Configuration
```
i2s_out:
  bck_pin: gpio.5      # SRCLK
  data_pin: gpio.4     # SER  
  ws_pin: gpio.6       # RCLK
  invert_bits: true    # For 6N136 optoisolators
```

### Stepper Motors
```
steppers:
  x:
    step_pin: i2so.0
    dir_pin: i2so.1
    disable_pin: i2so.8
    steps_per_mm: 200
    max_travel_mm: 200
    
  y:
    step_pin: i2so.2
    dir_pin: i2so.3
    disable_pin: i2so.9
    steps_per_mm: 200
    max_travel_mm: 200
    
  z:
    step_pin: i2so.4
    dir_pin: i2so.5
    disable_pin: i2so.10
    steps_per_mm: 200
    max_travel_mm: 100
    
  a:
    step_pin: i2so.6
    dir_pin: i2so.7
    disable_pin: i2so.11
    steps_per_mm: 200
    max_travel_mm: 41.5
```

### Limit Switches
```
limit_pins:
  x_pin: gpio.8:pu    # Active HIGH
  y_pin: gpio.15:pu   # Active HIGH
  z_pin: gpio.16:pu   # Active HIGH
  a_pin: gpio.17:pu   # Active HIGH
```

### Homing
```
homing:
  cycle: [z, x, y, a]
  mpos:
    x: 0
    y: 0
    z: 0
    a: 0
  feed_rate: 100
  seek_rate: 500
  debounce_ms: 250
  pull_off_mm: 0.5
```

### Safety
```
control:
  safety_door_pin: gpio.10
  reset_pin: gpio.11
  feed_hold_pin: gpio.18
  motor_fault_pin: gpio.21  # Safety feedback
```

### Networking
```
wifi:
  ssid: NETGEAR13
  password: [your_password]
  
webui:
  enable: true
  port: 80
  
telnet:
  enable: true
  port: 23
```

## Files Created/Modified

### Documentation
- `doc/A_AXIS_TEST_DISCOVERIES.md` - A-axis test results
- `doc/PROJECT_DEVELOPMENT_LOG.md` - Development timeline
- `doc/PIN_ASSIGNMENT_CORRECTIONS.md` - Pin configuration details
- `doc/LIQUID_HANDLING_WIRING.md` - Hardware wiring guide

### Code
- `Grbl_Esp32/src/Machines/liquid_handling_robot.h` - GRBL machine config
- `verification_test/src/main.cpp` - Working motor test program

### Configuration
- `Grbl_Esp32/platformio.ini` - Build settings
- `verification_test/platformio.ini` - Test build settings

## Next Steps

1. **Archive this repository** with "GRBL_ESP32_FAILURE" tag
2. **Create new FluidNC repository** using above configuration
3. **Migrate working hardware** to FluidNC firmware
4. **Resume development** with functional firmware

## Lessons Learned

1. **Test firmware compatibility** before full hardware integration
2. **Use verification programs** to isolate hardware vs software issues  
3. **Document working configurations** for future reference
4. **Don't assume firmware maturity** - GRBL_ESP32 has known ESP32-S3 issues

---

**Project Status:** FAILED - Firmware incompatibility  
**Hardware Status:** VERIFIED WORKING  
**Recommendation:** Migrate to FluidNC</content>
<parameter name="filePath">c:\Users\Molecular Reality\Documents\GRBL_ESP32\Grbl_Esp32-main\PROJECT_FAILURE_SUMMARY.md